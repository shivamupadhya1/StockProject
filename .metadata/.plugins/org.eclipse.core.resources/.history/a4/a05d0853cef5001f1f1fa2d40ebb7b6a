package com.stock.in.service;

import com.stock.in.dto.StockDTO;
import com.stock.in.exception.StockException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import yahoofinance.Stock;
import yahoofinance.YahooFinance;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Queue;
import java.util.concurrent.ConcurrentLinkedQueue;

@Slf4j
@Service
public class StockService {
    private static final String STOCK_SYMBOL = "^DJI";
    private final Queue<StockDTO> stockQueue = new ConcurrentLinkedQueue<>();

    @Scheduled(fixedRate = 5000)
    public void fetchStockPrice() {
        log.info("Scheduled task running: Fetching stock price...");
        try {
            log.info("Fetching stock price for: {}", STOCK_SYMBOL);
            Stock stock = YahooFinance.get(STOCK_SYMBOL);

            if (stock == null || stock.getQuote().getPrice() == null) {
                log.warn("Stock data is null for {}", STOCK_SYMBOL);
                return; // Avoid throwing exception
            }

            StockDTO stockData = new StockDTO(STOCK_SYMBOL, stock.getQuote().getPrice(), LocalDateTime.now());
            stockQueue.add(stockData);
            log.info("Fetched Stock: {}", stockData);

            // Keep only the last 10 stock prices
            if (stockQueue.size() > 10) {
                stockQueue.poll();
            }
        } catch (IOException e) {
            log.error("Error fetching stock price: {}", e.getMessage());
        }
    }

    public List<StockDTO> getRecentStockPrices() {
        List<StockDTO> stocks = List.copyOf(stockQueue);
        log.info("Returning {} stock records", stocks.size());
        return stocks;
    }
}
